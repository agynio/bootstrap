services:
  platform-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: agents
      POSTGRES_PASSWORD: agents
      POSTGRES_DB: agents
    volumes:
    - agyn_pgdata:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U agents -d agents
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - agents_stack
  litellm-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: litellm
      POSTGRES_USER: litellm
      POSTGRES_PASSWORD: change-me
    volumes:
    - litellm_pgdata:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U litellm -d litellm
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
    - agents_stack
  litellm:
    image: ghcr.io/berriai/litellm:v1.80.5-stable
    restart: unless-stopped
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-dev-master-1234}
      LITELLM_SALT_KEY: ${LITELLM_SALT_KEY:-sk-dev-salt-1234}
      DATABASE_URL: postgresql://litellm:change-me@litellm-db:5432/litellm
      STORE_MODEL_IN_DB: 'True'
      UI_USERNAME: ${LITELLM_UI_USERNAME:-admin}
      UI_PASSWORD: ${LITELLM_UI_PASSWORD:-admin}
      PORT: '4000'
      HOST: 0.0.0.0
    ports:
    - 4001:4000
    depends_on:
      litellm-db:
        condition: service_healthy
    networks:
    - agents_stack
  platform-server:
    user: root
    image: ghcr.io/hautechai/agents-platform-server:latest
    restart: unless-stopped
    environment:
      AGENTS_DATABASE_URL: postgresql://agents:agents@platform-db:5432/agents
      LLM_PROVIDER: litellm
      LITELLM_BASE_URL: http://litellm:4000
      LITELLM_MASTER_KEY: sk-dev-master-1234
      WORKSPACE_NETWORK_NAME: agents_stack
      CORS_ORIGINS: http://localhost:2496
      PORT: '3010'
      VAULT_ENABLED: 'true'
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: dev-root
      GRAPH_REPO_PATH: /opt/app/data/bootstrap/graph
      GRAPH_BRANCH: main
      GRAPH_AUTHOR_NAME: Agyn Platform
      GRAPH_AUTHOR_EMAIL: rowan.stein@agyn.io
      DOCKER_SOCKET: /var/run/docker.sock
    depends_on:
      platform-db:
        condition: service_healthy
      litellm:
        condition: service_started
      vault:
        condition: service_started
    expose:
    - '3010'
    command:
    - /bin/sh
    - -lc
    - set -e; prisma migrate deploy --schema /opt/app/packages/platform-server/prisma/schema.prisma;
      exec tsx src/index.ts
    volumes:
    - ../..:/opt/app/data/bootstrap
    - /var/run/docker.sock:/var/run/docker.sock
    networks:
    - agents_stack
  platform-ui:
    image: ghcr.io/hautechai/agents-platform-ui:latest
    restart: unless-stopped
    environment:
      API_UPSTREAM: http://platform-server:3010
    depends_on:
      platform-server:
        condition: service_started
    ports:
    - 2496:80
    networks:
    - agents_stack
  vault:
    image: hashicorp/vault:1.17
    restart: unless-stopped
    cap_add:
    - IPC_LOCK
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_LOCAL_CONFIG: "ui = true\ncluster_name = \"local-vault\"\ndisable_mlock\
        \ = true\nlistener \"tcp\" {\n  address     = \"0.0.0.0:8200\"\n  tls_disable\
        \ = 1\n}\nstorage \"file\" {\n  path = \"/vault/file\"\n}\napi_addr     =\
        \ \"http://vault:8200\"\ncluster_addr = \"http://vault:8201\"\n"
    command:
    - server
    volumes:
    - vault-file:/vault/file
    networks:
    - agents_stack
  vault-auto-init:
    image: hashicorp/vault:1.17
    depends_on:
    - vault
    restart: 'no'
    environment:
      VAULT_ADDR: http://vault:8200
    volumes:
    - vault-file:/vault/file
    - ./vault/auto-init.sh:/auto-init.sh:ro
    entrypoint:
    - /bin/sh
    - /auto-init.sh
    networks:
    - agents_stack
networks:
  agents_stack:
    driver: bridge
volumes:
  agyn_pgdata: null
  litellm_pgdata: null
  vault-file: null
