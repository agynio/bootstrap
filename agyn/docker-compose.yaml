# Isolated bootstrap compose to ship Agents platform to clients.
# Includes all required dependencies and exposes a single port 2496 for the UI reverse proxy.

services:
  # Postgres for Agents persistent state
  platform-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: agents
      POSTGRES_PASSWORD: agents
      POSTGRES_DB: agents
    volumes:
      - agyn_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agents -d agents"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agents_stack

  # LiteLLM Postgres database
  litellm-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: litellm
      POSTGRES_USER: litellm
      POSTGRES_PASSWORD: change-me
    volumes:
      - litellm_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U litellm -d litellm"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - agents_stack

  # LiteLLM service
  litellm:
    image: ghcr.io/berriai/litellm:v1.80.5-stable
    restart: unless-stopped
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-dev-master-1234}
      LITELLM_SALT_KEY: ${LITELLM_SALT_KEY:-sk-dev-salt-1234}
      DATABASE_URL: postgresql://litellm:change-me@litellm-db:5432/litellm
      STORE_MODEL_IN_DB: "True"
      UI_USERNAME: ${LITELLM_UI_USERNAME:-admin}
      UI_PASSWORD: ${LITELLM_UI_PASSWORD:-admin}
      PORT: "4000"
      HOST: "0.0.0.0"
    ports:
      - "4001:4000"
    depends_on:
      litellm-db:
        condition: service_healthy
    networks:
      - agents_stack

  docker-runner:
    image: ghcr.io/agynio/docker-runner:0.14.4
    restart: unless-stopped
    environment:
      DOCKER_RUNNER_HOST: "0.0.0.0"
      DOCKER_RUNNER_PORT: "7071"
      DOCKER_RUNNER_SHARED_SECRET: ${DOCKER_RUNNER_SHARED_SECRET:-change-me}
      DOCKER_SOCKET: /var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    group_add:
      - 0
    networks:
      - agents_stack

  registry-mirror:
    image: registry:2
    restart: unless-stopped
    environment:
      REGISTRY_HTTP_ADDR: 0.0.0.0:5000
      REGISTRY_PROXY_REMOTEURL: https://registry-1.docker.io
    networks:
      - agents_stack
    volumes:
      - registry-cache:/var/lib/registry

  # Platform server (NestJS) — internal only, UI will proxy
  platform-server:
    user: root
    image: ghcr.io/agynio/platform-server:0.14.4
    restart: unless-stopped
    environment:
      AGENTS_DATABASE_URL: postgresql://agents:agents@platform-db:5432/agents
      LLM_PROVIDER: litellm
      LITELLM_BASE_URL: http://litellm:4000
      LITELLM_MASTER_KEY: sk-dev-master-1234
      WORKSPACE_NETWORK_NAME: agyn_agents_stack
      CORS_ORIGINS: http://localhost:2496
      PORT: "3010"
      VAULT_ENABLED: 'true'
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: dev-root
      GRAPH_REPO_PATH: /opt/app/data/bootstrap/graph
      GRAPH_BRANCH: v0.10.1
      GRAPH_AUTHOR_NAME: Agyn Platform
      GRAPH_AUTHOR_EMAIL: rowan.stein@agyn.io
      DOCKER_RUNNER_BASE_URL: http://docker-runner:7071
      DOCKER_RUNNER_SHARED_SECRET: ${DOCKER_RUNNER_SHARED_SECRET:-change-me}
      # DOCKER_RUNNER_TIMEOUT_MS: "30000"
    depends_on:
      platform-db:
        condition: service_healthy
      litellm:
        condition: service_started
      vault:
        condition: service_started
      docker-runner:
        condition: service_started
    expose:
      - "3010"
    # Run DB migrations then start the server. Requires prisma CLI in the image (now included).
    command: ["/bin/sh", "-lc", "set -e; prisma migrate deploy --schema /opt/app/packages/platform-server/prisma/schema.prisma; exec tsx src/index.ts"]
    volumes:
      - ..:/opt/app/data/bootstrap
    networks:
      - agents_stack

  # Platform UI reverse proxy — the only exposed service
  platform-ui:
    image: ghcr.io/agynio/platform-ui:0.14.5
    restart: unless-stopped
    environment:
      API_UPSTREAM: http://platform-server:3010
    depends_on:
      platform-server:
        condition: service_started
    ports:
      - "2496:80"
    networks:
      - agents_stack

  vault:
    image: hashicorp/vault:1.17
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_LOCAL_CONFIG: |
        ui = true
        cluster_name = "local-vault"
        disable_mlock = true
        listener "tcp" {
          address     = "0.0.0.0:8200"
          tls_disable = 1
        }
        storage "file" {
          path = "/vault/file"
        }
        api_addr     = "http://vault:8200"
        cluster_addr = "http://vault:8201"
    ports:
      - "8202:8200"
    command: ["server"]
    volumes:
      - vault-file:/vault/file
    networks:
      - agents_stack
  
  vault-auto-init:
    image: hashicorp/vault:1.17
    depends_on:
      - vault
    restart: "no"
    environment:
      VAULT_ADDR: http://vault:8200
    volumes:
      - vault-file:/vault/file
      - ./vault/auto-init.sh:/auto-init.sh:ro
    entrypoint: ["/bin/sh", "/auto-init.sh"]
    networks:
      - agents_stack


networks:
  agents_stack:
    driver: bridge

volumes:
  agyn_pgdata:
  litellm_pgdata:
  vault-file:
  registry-cache:
